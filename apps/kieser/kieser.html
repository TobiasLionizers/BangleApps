<html>

<head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
</head>

<body onload="createTable()">
    <h1>Kieser</h1>

    <p>
        Enter your training plan here. The weight will be increased/decreased automatically according to your training
        time.
    </p>
    <div id="cont">
        <h4>Trainingsplan</h4>
    </div>
    <p>
        <input type="button" id="bt" value="Add New Machine" onclick="addRow()" />
    </p>


    <br><br>
    <button id="upload" class="btn btn-primary">Upload</button>

    <script src="../../core/lib/interface.js"></script>

    <script>
       
        function createTable() {
            var arrHead = new Array();
            arrHead = ['', 'Machine Name', 'Settings', 'Weight']; // table headers.

            var machineTable = document.createElement('table');
            machineTable.setAttribute('id', 'machineTable');

            var tr = machineTable.insertRow(-1);

            for (var h = 0; h < arrHead.length; h++) {
                var th = document.createElement('th'); // the header object.
                th.innerHTML = arrHead[h];
                tr.appendChild(th);
            }

            var div = document.getElementById('cont');
            div.appendChild(machineTable);
            addRow();
        }

        function addRow() {
            var machineTable = document.getElementById("machineTable");
            var rowCount = machineTable.rows.length;
            var tr = machineTable.insertRow(rowCount);

            tdRemoveButton = tr.insertCell(0);
            var removeButton = document.createElement('input');
            removeButton.setAttribute('type', 'button');
            removeButton.setAttribute('value', 'Remove');
            removeButton.setAttribute('onclick', 'removeRow(this)');
            tdRemoveButton.appendChild(removeButton);

            tdMachine = tr.insertCell(1);
            var machineElement = document.createElement('input');
            machineElement.setAttribute('type', 'text');
            machineElement.setAttribute('value', '');
            tdMachine.appendChild(machineElement);

            tdSetting = tr.insertCell(2);
            var settingElement = document.createElement('input');
            settingElement.setAttribute('type', 'text');
            settingElement.setAttribute('value', '');
            tdSetting.appendChild(settingElement);
            var addSettingButton = document.createElement('input');
            addSettingButton.setAttribute('type', 'button')
            addSettingButton.setAttribute('value', 'Add Setting');
            addSettingButton.setAttribute('onclick', 'addSetting(this)');
            tdSetting.appendChild(addSettingButton);

            tdWeight = tr.insertCell(3);
            var weightElement = document.createElement('input');
            weightElement.setAttribute('type', 'number');
            weightElement.setAttribute('value', '');
            tdWeight.appendChild(weightElement);
        }

        function removeRow(oButton) {
            var machineTable = document.getElementById('machineTable');
            machineTable.deleteRow(oButton.parentNode.parentNode.rowIndex); // buttton -> td -> tr
        }

        function addSetting(button){
            var tdSetting = button.parentNode;
            var br = document.createElement('br');
            tdSetting.insertBefore(br, tdSetting.lastChild);
            var settingElement = document.createElement('input');
            settingElement.setAttribute('type', 'text');
            settingElement.setAttribute('value', '');
            tdSetting.insertBefore(settingElement, tdSetting.lastChild);
            var br = document.createElement('br');
            tdSetting.insertBefore(br, tdSetting.lastChild);
        }

        function collectValues(){
            machineTable = document.getElementById("machineTable");
            var trainingplan = new Array();

            // loop through each row of the table.
            for (row = 1; row < machineTable.rows.length; row++) {
                var rowObject = new Object();
                var machine = machineTable.rows.item(row).cells[1].childNodes[0].value;
                rowObject.machine = machine;
                var settingsArray = new Array();
                var settingsCell =  machineTable.rows.item(row).cells[2];
                for (c = 0; c < settingsCell.childNodes.length-1; c++) {
                    var element = settingsCell.childNodes[c];
                        if (element.getAttribute('type') == 'text'){
                            settingsArray.push(element.value);
                        }
                }
                rowObject.settings = settingsArray;
                var weight = machineTable.rows.item(row).cells[3].childNodes[0].value;
                rowObject.weight = weight;
                trainingplan.push(rowObject);
            }
                
            
            
            console.log(trainingplan);
            return trainingplan;
        }
        
        document.getElementById("upload").addEventListener("click", function () {
            values = collectValues();
            console.log("!!!!!!!!!!!!!!!")
            console.log(values);
            console.log(JSON.stringify(values));
            console.log("____________________");
            Puck.eval(`require("Storage").writeJSON("kieser-trainingplan.json", ${JSON.stringify(values)})`, () => {
                Puck.eval(`Bangle.buzz()`, () => {
                    console.log("all done");
                })
            });
        });




    </script>
</body>

</html>
